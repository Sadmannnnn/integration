Описание: Серверный модуль для выполнения HTTP-запросов и обработки JSON
&НаСервере
// ============================================================================
// ФУНКЦИЯ: ВыполнитьHTTPЗапрос
// Назначение: Универсальная функция для выполнения HTTP-запросов к внешним API
// Возвращает: Структура {Успех, Данные, Ошибка, КодОтвета}
// ============================================================================
Функция ВыполнитьHTTPЗапрос(Метод, URL, Заголовки = Неопределено, Тело = "", Таймаут = 30) Экспорт

text
Результат = Новый Структура("Успех, Данные, Ошибка, КодОтвета", Ложь, "", "", 0);

Попытка
    // 1. СОЗДАНИЕ И НАСТРОЙКА ПОДКЛЮЧЕНИЯ
    HTTPСоединение = Новый HTTPСоединение(URL, Таймаут);
    
    // 2. ФОРМИРОВАНИЕ ЗАПРОСА
    HTTPЗапрос = Новый HTTPЗапрос();
    Если Метод = "GET" Тогда
        HTTPЗапрос.Метод = "GET";
    ИначеЕсли Метод = "POST" Тогда
        HTTPЗапрос.Метод = "POST";
        Если Тело <> "" Тогда
            HTTPЗапрос.УстановитьТелоИзСтроки(Тело, КодировкаТекста.UTF8);
        КонецЕсли;
    КонецЕсли;
    
    // 3. УСТАНОВКА ЗАГОЛОВКОВ (важно для REST API)
    Если Заголовки = Неопределено Тогда
        Заголовки = Новый Соответствие;
    КонецЕсли;
    
    // Обязательные заголовки для JSON API
    Если Не Заголовки.СодержитКлюч("Content-Type") Тогда
        Заголовки.Вставить("Content-Type", "application/json");
    КонецЕсли;
    
    Если Не Заголовки.СодержитКлюч("User-Agent") Тогда
        Заголовки.Вставить("User-Agent", "1C-Integration/1.0");
    КонецЕсли;
    
    // Применяем все заголовки к запросу
    Для Каждого КлючИЗначение Из Заголовки Цикл
        HTTPЗапрос.Заголовки.Вставить(КлючИЗначение.Ключ, КлючИЗначение.Значение);
    КонецЦикла;
    
    // 4. ВЫПОЛНЕНИЕ ЗАПРОСА И ОБРАБОТКА ОТВЕТА
    HTTPОтвет = HTTPСоединение.Получить(HTTPЗапрос);
    Результат.КодОтвета = HTTPОтвет.КодСостояния;
    
    // 5. ПРОВЕРКА УСПЕШНОСТИ ОТВЕТА
    Если HTTPОтвет.КодСостояния >= 200 И HTTPОтвет.КодСостояния < 300 Тогда
        // УСПЕШНЫЙ ОТВЕТ
        Результат.Данные = HTTPОтвет.ПолучитьТелоКакСтроку(КодировкаТекста.UTF8);
        Результат.Успех = Истина;
    Иначе
        // ОШИБКА СЕРВЕРА
        ТекстОшибки = HTTPОтвет.ПолучитьТелоКакСтроку(КодировкаТекста.UTF8);
        Результат.Ошибка = "HTTP ошибка " + HTTPОтвет.КодСостояния + ": " + ТекстОшибки;
        Результат.Успех = Ложь;
    КонецЕсли;
    
Исключение
    // ОБРАБОТКА ОШИБОК СЕТИ ИЛИ ПАРСИНГА
    ОписаниеОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
    Результат.Ошибка = "Ошибка выполнения запроса: " + ОписаниеОшибки;
    Результат.Успех = Ложь;
КонецПопытки;

Возврат Результат;
КонецФункции // ВыполнитьHTTPЗапрос

&НаСервере
// ============================================================================
// ФУНКЦИЯ: РазобратьJSONОтвет
// Назначение: Парсинг JSON строки в структуру данных 1С
// ============================================================================
Функция РазобратьJSONОтвет(JSONСтрока) Экспорт

text
Результат = Новый Структура("Успех, Данные, Ошибка");

Попытка
    Если ПустаяСтрока(JSONСтрока) Тогда
        Результат.Ошибка = "Получена пустая JSON строка";
        Возврат Результат;
    КонецЕсли;
    
    // Используем встроенный парсер JSON (доступен с версии 8.3.10)
    ЧтениеJSON = Новый ЧтениеJSON;
    ЧтениеJSON.УстановитьСтроку(JSONСтрока);
    
    РазборJSON = ПрочитатьJSON(ЧтениеJSON);
    
    Результат.Данные = РазборJSON;
    Результат.Успех = Истина;
    
Исключение
    Результат.Ошибка = "Ошибка разбора JSON: " + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
    Результат.Успех = Ложь;
КонецПопытки;

Возврат Результат;
КонецФункции // РазобратьJSONОтвет

&НаСервере
// ============================================================================
// ФУНКЦИЯ: ЗагрузитьЗаказыИзAPI
// Назначение: Основная функция загрузки заказов из внешней системы
// ============================================================================
Функция ЗагрузитьЗаказыИзAPI(URL_API, API_Ключ, ДатаНачала, ДатаОкончания) Экспорт

text
РезультатОперации = Новый Структура("Успех, КоличествоЗаказов, Ошибка, Заказы");
РезультатОперации.Заказы = Новый Массив;

Попытка
    // 1. ПОДГОТОВКА ПАРАМЕТРОВ ЗАПРОСА
    Заголовки = Новый Соответствие;
    Заголовки.Вставить("Authorization", "Bearer " + API_Ключ);
    
    // 2. ФОРМИРОВАНИЕ ТЕЛА ЗАПРОСА (если нужно)
    ПараметрыЗапроса = Новый Соответствие;
    ПараметрыЗапроса.Вставить("start_date", Формат(ДатаНачала, "ДФ=yyyy-MM-dd"));
    ПараметрыЗапроса.Вставить("end_date", Формат(ДатаОкончания, "ДФ=yyyy-MM-dd"));
    ПараметрыЗапроса.Вставить("limit", "100");
    
    // Преобразуем параметры в JSON
    ЗаписьJSON = Новый ЗаписьJSON;
    ЗаписьJSON.ЗаписатьОбъект(ПараметрыЗапроса);
    ТелоЗапроса = ЗаписьJSON.Закрыть();
    
    // 3. ВЫПОЛНЕНИЕ HTTP-ЗАПРОСА
    РезультатЗапроса = ВыполнитьHTTPЗапрос("POST", URL_API, Заголовки, ТелоЗапроса, 60);
    
    Если Не РезультатЗапроса.Успех Тогда
        РезультатОперации.Ошибка = "Ошибка HTTP запроса: " + РезультатЗапроса.Ошибка;
        Возврат РезультатОперации;
    КонецЕсли;
    
    // 4. РАЗБОР JSON ОТВЕТА
    РезультатJSON = РазобратьJSONОтвет(РезультатЗапроса.Данные);
    
    Если Не РезультатJSON.Успех Тогда
        РезультатОперации.Ошибка = "Ошибка разбора JSON: " + РезультатJSON.Ошибка;
        Возврат РезультатОперации;
    КонецЕсли;
    
    // 5. ПРЕОБРАЗОВАНИЕ ДАННЫХ В СТРУКТУРЫ 1С
    ДанныеAPI = РезультатJSON.Данные;
    
    Если ТипЗнч(ДанныеAPI) = Тип("Массив") Тогда
        // Обрабатываем массив заказов
        Для Каждого Элемент Из ДанныеAPI Цикл
            Если ТипЗнч(Элемент) = Тип("Соответствие") Тогда
                Заказ = ОбработатьЗаказИзAPI(Элемент);
                Если Заказ <> Неопределено Тогда
                    РезультатОперации.Заказы.Добавить(Заказ);
                КонецЕсли;
            КонецЕсли;
        КонецЦикла;
        
        РезультатОперации.КоличествоЗаказов = РезультатОперации.Заказы.Количество();
        РезультатОперации.Успех = Истина;
        
    ИначеЕсли ТипЗнч(ДанныеAPI) = Тип("Соответствие") Тогда
        // Проверяем стандартную структуру ответа API
        Если ДанныеAPI.Свойство("orders") Тогда
            ЗаказыИзAPI = ДанныеAPI.orders;
            Если ТипЗнч(ЗаказыИзAPI) = Тип("Массив") Тогда
                Для Каждого ЗаказAPI Из ЗаказыИзAPI Цикл
                    Заказ = ОбработатьЗаказИзAPI(ЗаказAPI);
                    Если Заказ <> Неопределено Тогда
                        РезультатОперации.Заказы.Добавить(Заказ);
                    КонецЕсли;
                КонецЦикла;
                
                РезультатОперации.КоличествоЗаказов = РезультатОперации.Заказы.Количество();
                РезультатОперации.Успех = Истина;
            КонецЕсли;
        КонецЕсли;
    КонецЕсли;
    
    Если РезультатОперации.КоличествоЗаказов = 0 Тогда
        РезультатОперации.Ошибка = "Не найдено заказов для указанного периода";
    КонецЕсли;
    
Исключение
    РезультатОперации.Ошибка = "Общая ошибка загрузки: " + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
    РезультатОперации.Успех = Ложь;
КонецПопытки;

Возврат РезультатОперации;
КонецФункции // ЗагрузитьЗаказыИзAPI

&НаСервере
// ============================================================================
// ФУНКЦИЯ: ОбработатьЗаказИзAPI
// Назначение: Преобразование данных одного заказа из API в структуру 1С
// ============================================================================
Функция ОбработатьЗаказИзAPI(ДанныеЗаказа)

text
Если ТипЗнч(ДанныеЗаказа) <> Тип("Соответствие") Тогда
    Возврат Неопределено;
КонецЕсли;

Попытка
    Заказ = Новый Структура;
    
    // Извлекаем основные поля заказа
    Если ДанныеЗаказа.Свойство("id") Тогда
        Заказ.Вставить("ВнешнийID", ДанныеЗаказа.id);
    КонецЕсли;
    
    Если ДанныеЗаказа.Свойство("order_date") Тогда
        // Преобразуем строку даты в дату 1С
        СтрокаДаты = ДанныеЗаказа.order_date;
        Заказ.Вставить("ДатаЗаказа", Дата(СтрокаДаты));
    КонецЕсли;
    
    Если ДанныеЗаказа.Свойство("customer") Тогда
        КлиентAPI = ДанныеЗаказа.customer;
        Если ТипЗнч(КлиентAPI) = Тип("Соответствие") Тогда
            Заказ.Вставить("ИмяКлиента", КлиентAPI.Свойство("name") ? КлиентAPI.name : "");
            Заказ.Вставить("EmailКлиента", КлиентAPI.Свойство("email") ? КлиентAPI.email : "");
            Заказ.Вставить("ТелефонКлиента", КлиентAPI.Свойство("phone") ? КлиентAPI.phone : "");
        КонецЕсли;
    КонецЕсли;
    
    // Обрабатываем товарные позиции
    Если ДанныеЗаказа.Свойство("items") И ТипЗнч(ДанныеЗаказа.items) = Тип("Массив") Тогда
        Товары = Новый Массив;
        ОбщаяСумма = 0;
        
        Для Каждого ТоварAPI Из ДанныеЗаказа.items Цикл
            Если ТипЗнч(ТоварAPI) = Тип("Соответствие") Тогда
                Товар = Новый Структура;
                
                Товар.Вставить("КодТовара", ТоварAPI.Свойство("sku") ? ТоварAPI.sku : "");
                Товар.Вставить("Название", ТоварAPI.Свойство("name") ? ТоварAPI.name : "");
                Товар.Вставить("Количество", ТоварAPI.Свойство("quantity") ? Число(ТоварAPI.quantity) : 0);
                Товар.Вставить("Цена", ТоварAPI.Свойство("price") ? Число(ТоварAPI.price) : 0);
                Товар.Вставить("Сумма", Товар.Количество * Товар.Цена);
                
                ОбщаяСумма = ОбщаяСумма + Товар.Сумма;
                Товары.Добавить(Товар);
            КонецЕсли;
        КонецЦикла;
        
        Заказ.Вставить("Товары", Товары);
        Заказ.Вставить("ОбщаяСумма", ОбщаяСумма);
    КонецЕсли;
    
    // Статус заказа
    Если ДанныеЗаказа.Свойство("status") Тогда
        Заказ.Вставить("Статус", ДанныеЗаказа.status);
    КонецЕсли;
    
    Возврат Заказ;
    
Исключение
    // Логируем ошибку, но не прерываем обработку других заказов
    // В реальном проекте здесь была бы запись в журнал
    Возврат Неопределено;
КонецПопытки;
КонецФункции // ОбработатьЗаказИзAPI

&НаСервере
// ============================================================================
// ФУНКЦИЯ: СоздатьДокументыЗаказов
// Назначение: Создание документов "ЗаказКлиента" на основе данных из API
// Использует транзакцию для гарантии целостности данных
// ============================================================================
Функция СоздатьДокументыЗаказов(МассивЗаказов, СкладПоУмолчанию = Неопределено) Экспорт

text
Результат = Новый Структура("Успех, Создано, Ошибка, Документы");
Результат.Документы = Новый Массив;
Результат.Создано = 0;

Если МассивЗаказов = Неопределено Или МассивЗаказов.Количество() = 0 Тогда
    Результат.Ошибка = "Нет данных заказов для создания";
    Возврат Результат;
КонецЕсли;

// НАЧАЛО ТРАНЗАКЦИИ - важно для целостности
Попытка
    НачатьТранзакцию();
    
    Для Каждого ДанныеЗаказа Из МассивЗаказов Цикл
        Попытка
            // СОЗДАНИЕ НОВОГО ДОКУМЕНТА
            НовыйДокумент = Документы.ЗаказКлиента.СоздатьДокумент();
            
            // ЗАПОЛНЕНИЕ ШАПКИ ДОКУМЕНТА
            НовыйДокумент.Дата = ДанныеЗаказа.ДатаЗаказа ? ДанныеЗаказа.ДатаЗаказа : ТекущаяДата();
            
            // Поиск или создание контрагента
            Если ДанныеЗаказа.Свойство("ИмяКлиента") Тогда
                Контрагент = НайтиИлиСоздатьКонтрагента(ДанныеЗаказа.ИмяКлиента, 
                                                      ДанныеЗаказа.EmailКлиента,
                                                      ДанныеЗаказа.ТелефонКлиента);
                Если Контрагент <> Неопределено Тогда
                    НовыйДокумент.Контрагент = Контрагент;
                КонецЕсли;
            КонецЕсли;
            
            // Склад
            Если СкладПоУмолчанию <> Неопределено Тогда
                НовыйДокумент.Склад = СкладПоУмолчанию;
            КонецЕсли;
            
            // Внешний комментарий или ID
            Если ДанныеЗаказа.Свойство("ВнешнийID") Тогда
                НовыйДокумент.Комментарий = "Импорт из API. ID: " + ДанныеЗаказа.ВнешнийID;
            КонецЕсли;
            
            // ЗАПОЛНЕНИЕ ТАБЛИЧНОЙ ЧАСТИ ТОВАРАМИ
            Если ДанныеЗаказа.Свойство("Товары") Тогда
                Для Каждого Товар Из ДанныеЗаказа.Товары Цикл
                    СтрокаТовара = НовыйДокумент.Товары.Добавить();
                    
                    // Поиск номенклатуры по коду или названию
                    Номенклатура = НайтиИлиСоздатьНоменклатуру(Товар.КодТовара, Товар.Название);
                    Если Номенклатура <> Неопределено Тогда
                        СтрокаТовара.Номенклатура = Номенклатура;
                        СтрокаТовара.Количество = Товар.Количество;
                        СтрокаТовара.Цена = Товар.Цена;
                        СтрокаТовара.Сумма = Товар.Сумма;
                    КонецЕсли;
                КонецЦикла;
            КонецЕсли;
            
            // ПРОВЕРКА И СОХРАНЕНИЕ ДОКУМЕНТА
            Если НовыйДокумент.Товары.Количество() > 0 Тогда
                НовыйДокумент.Записать();
                НовыйДокумент.Провести();
                
                Результат.Документы.Добавить(НовыйДокумент.Ссылка);
                Результат.Создано = Результат.Создано + 1;
            КонецЕсли;
            
        Исключение
            // Логируем ошибку, но продолжаем обработку других заказов
            // В реальном проекте здесь была бы запись в журнал
            Продолжить;
        КонецПопытки;
    КонецЦикла;
    
    // ФИКСАЦИЯ ТРАНЗАКЦИИ - все документы созданы успешно
    ЗафиксироватьТранзакцию();
    Результат.Успех = Истина;
    
Исключение
    // ОТКАТ ТРАНЗАКЦИИ ПРИ ОШИБКЕ - гарантия целостности
    ОтменитьТранзакцию();
    Результат.Ошибка = "Ошибка создания документов: " + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
    Результат.Успех = Ложь;
КонецПопытки;

Возврат Результат;
КонецФункции // СоздатьДокументыЗаказов

&НаСервере
// ============================================================================
// ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ
// ============================================================================

Функция НайтиИлиСоздатьКонтрагента(Имя, Email, Телефон)
// Упрощенная реализация - в реальном проекте была бы сложнее
Попытка
// Поиск по имени
Запрос = Новый Запрос;
Запрос.Текст =
"ВЫБРАТЬ ПЕРВЫЕ 1
| Контрагенты.Ссылка
|ИЗ
| Справочник.Контрагенты КАК Контрагенты
|ГДЕ
| Контрагенты.Наименование = &Имя";

text
    Запрос.УстановитьПараметр("Имя", Имя);
    Результат = Запрос.Выполнить();
    
    Если Не Результат.Пустой() Тогда
        Возврат Результат.Выбрать().Ссылка;
    КонецЕсли;
    
    // Создание нового контрагента
    НовыйКонтрагент = Справочники.Контрагенты.СоздатьЭлемент();
    НовыйКонтрагент.Наименование = Имя;
    Если Не ПустаяСтрока(Email) Тогда
        НовыйКонтрагент.ЭлектроннаяПочта = Email;
    КонецЕсли;
    Если Не ПустаяСтрока(Телефон) Тогда
        НовыйКонтрагент.Телефон = Телефон;
    КонецЕсли;
    
    НовыйКонтрагент.Записать();
    Возврат НовыйКонтрагент.Ссылка;
    
Исключение
    Возврат Неопределено;
КонецПопытки;
КонецФункции

Функция НайтиИлиСоздатьНоменклатуру(Код, Наименование)
Попытка
Если Не ПустаяСтрока(Код) Тогда
// Поиск по коду
Запрос = Новый Запрос;
Запрос.Текст =
"ВЫБРАТЬ ПЕРВЫЕ 1
| Номенклатура.Ссылка
|ИЗ
| Справочник.Номенклатура КАК Номенклатура
|ГДЕ
| Номенклатура.Код = &Код";

text
        Запрос.УстановитьПараметр("Код", Код);
        Результат = Запрос.Выполнить();
        
        Если Не Результат.Пустой() Тогда
            Возврат Результат.Выбрать().Ссылка;
        КонецЕсли;
    КонецЕсли;
    
    // Создание новой номенклатуры
    НоваяНоменклатура = Справочники.Номенклатура.СоздатьЭлемент();
    Если Не ПустаяСтрока(Код) Тогда
        НоваяНоменклатура.Код = Код;
    КонецЕсли;
    НоваяНоменклатура.Наименование = Наименование;
    
    НоваяНоменклатура.Записать();
    Возврат НоваяНоменклатура.Ссылка;
    
Исключение
    Возврат Неопределено;
КонецПопытки;
КонецФункции

// ============================================================================
// ПРИМЕР ИСПОЛЬЗОВАНИЯ (для демонстрации в тестовой обработке)
// ============================================================================
&НаСервере
Процедура ЗагрузитьИСоздатьЗаказы()

text
// ПАРАМЕТРЫ ИНТЕГРАЦИИ
URL_API = "https://api.example.com/v1/orders";
API_Ключ = "your_api_key_here";
ДатаНачала = НачалоДня(ДобавитьМесяц(ТекущаяДата(), -1));
ДатаОкончания = КонецДня(ТекущаяДата());

// 1. ЗАГРУЗКА ДАННЫХ ИЗ API
Сообщить("Начало загрузки заказов из API...");
ЗаказыИзAPI = ЗагрузитьЗаказыИзAPI(URL_API, API_Ключ, ДатаНачала, ДатаОкончания);

Если Не ЗаказыИзAPI.Успех Тогда
    Сообщить("Ошибка загрузки: " + ЗаказыИзAPI.Ошибка, СтатусСообщения.Важное);
    Возврат;
КонецЕсли;

Сообщить("Загружено заказов: " + ЗаказыИзAPI.КоличествоЗаказов);

// 2. СОЗДАНИЕ ДОКУМЕНТОВ В 1С
Если ЗаказыИзAPI.КоличествоЗаказов > 0 Тогда
    Сообщить("Создание документов в 1С...");
    
    // Получаем склад по умолчанию
    Запрос = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 1 Склады.Ссылка ИЗ Справочник.Склады КАК Склады");
    Склад = Запрос.Выполнить().Выбрать().Ссылка;
    
    РезультатСоздания = СоздатьДокументыЗаказов(ЗаказыИзAPI.Заказы, Склад);
    
    Если РезультатСоздания.Успех Тогда
        Сообщить("Успешно создано документов: " + РезультатСоздания.Создано);
        Сообщить("Готово!", СтатусСообщения.ОК);
    Иначе
        Сообщить("Ошибка создания документов: " + РезультатСоздания.Ошибка, СтатусСообщения.Важное);
    КонецЕсли;
Иначе
    Сообщить("Нет новых заказов для создания");
КонецЕсли;
КонецПроцедуры

// ============================================================================
// КОНЕЦ ФАЙЛА MAIN_CODE.bsl
// ============================================================================